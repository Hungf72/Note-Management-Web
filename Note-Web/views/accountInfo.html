<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>NotezyNeko - Account Info</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body>
    <div class="card mx-auto mt-4" style="max-width: 420px;">
        <div class="card-body">
            <form id="userForm">
                <div class="form-group text-center">
                    <label for="popupAvatarInput" style="margin-bottom:0;cursor:pointer;">
                        <img id="popupUserInfo" src="/Note-Management-Web/Note-Web/images/personal.png" alt="User Icon" class="rounded-circle mb-2" style="width: 90px; height: 90px; object-fit: cover;">
                        <input type="file" id="popupAvatarInput" accept="image/*" style="display:none;">
                    </label>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="lastNameUser">Last Name</label>
                        <input name="lastname" type="text" class="form-control" id="lastNameUser" placeholder="Huynh" required readonly>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="firstNameUser">First Name</label>
                        <input name="firstname" type="text" class="form-control" id="firstNameUser" placeholder="Kyle" required readonly> 
                    </div>
                </div>
                <div class="form-group">
                    <label for="emailUser">Email</label>
                    <input name="email" type="email" class="form-control" id="emailUser" placeholder="example@email.com" required readonly>
                </div>
                <div class="form-group">
                    <label for="ageUser">Age</label>
                    <input name="age" type="number" class="form-control" id="ageUser" placeholder="Age" min="1" max="100" required readonly>
                </div>
                <div class="form-group">
                    <label for="phoneUser">Phone number</label>
                    <input name="phone" type="tel" class="form-control" id="phoneUser" placeholder="0901234567" pattern="[0-9]{10,11}" required readonly>
                </div>
                <div class="d-flex justify-content-between">
                    <button style="width: 130px;" type="button" id="editBtn" class="btn btn-primary">Edit</button>
                    <button style="width: 130px;" type="submit" id="saveBtn" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
           fetch('/Note-Management-Web/Note-Web/controllers/getUser.php', {
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('lastNameUser').value = data.lastName;
                    document.getElementById('firstNameUser').value = data.firstName;
                    document.getElementById('emailUser').value = data.email;
                    document.getElementById('ageUser').value = data.age;
                    document.getElementById('phoneUser').value = data.phone;
                    // Set avatar for card
                    let avatarUrl = data.avatar;
                    if (avatarUrl) {
                        avatarUrl ='/Note-Management-Web/Note-Web/' + avatarUrl.replace(/\\/g, '/');
                    } 
                    else {
                        avatarUrl = '/Note-Management-Web/Note-Web/images/personal.png';
                    }
                    document.getElementById('popupUserInfo').src = avatarUrl;
                }
            })
            .catch(error => {
                console.error('Lỗi khi lấy user:', error);
            });
        });

        // edit
        document.getElementById('editBtn').addEventListener('click', () =>{
            ['firstNameUser', 'lastNameUser', 'ageUser', 'phoneUser'].forEach(id => {
                document.getElementById(id).readOnly = false;
            });
        });

        // update information
        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const popupAvatar = document.getElementById('popupUserInfo');
            const popupAvatarInput = document.getElementById('popupAvatarInput');
            if (popupAvatarInput.files && popupAvatarInput.files[0]) {
                formData.append('avatar', popupAvatarInput.files[0]);
            }
            fetch('/Note-Management-Web/Note-Web/controllers/updateUser.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                // Hiển thị thông báo nếu muốn
                if (data.status === "success") {
                    fetch('/Note-Management-Web/Note-Web/controllers/getUser.php', {
                        credentials: 'include'
                    })
                    .then(res => res.json())
                    .then(user => {
                        if (user.status === 'success') {
                            document.getElementById('emailUser').value = user.email;
                            document.getElementById('firstNameUser').value = user.firstName;
                            document.getElementById('lastNameUser').value = user.lastName;
                            document.getElementById('ageUser').value = user.age;
                            document.getElementById('phoneUser').value = user.phone;

                            // Update avatar after save
                            let avatarUrl = user.avatar;
                            if (avatarUrl) {
                                avatarUrl = '/Note-Management-Web/Note-Web/' + avatarUrl;
                            } 
                            else {
                                avatarUrl = '/Note-Management-Web/Note-Web/images/personal.png';
                            }
                            document.getElementById('popupUserInfo').src = avatarUrl;
                        }
            
                        ['firstNameUser', 'lastNameUser', 'ageUser', 'phoneUser'].forEach(id => {
                            document.getElementById(id).readOnly = true;
                        });

                        window.location.href = "home.html";
                    });
                }
            })
            .catch(err => {
                console.error('Lỗi khi cập nhật:', err);
            });
        });

        // avatar change
        document.getElementById('popupAvatarInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(evt) {
                document.getElementById('popupUserInfo').src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
</body>
</html>